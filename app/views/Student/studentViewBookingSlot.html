<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Student - Time Slots</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        /* ✅ 自訂主題紅 */
        .bg-primary-red {
            background-color: #C8102E !important;
        }

        .text-primary-red {
            color: #C8102E !important;
        }

        .btn-primary-red {
            background-color: #C8102E !important;
            border-color: #C8102E !important;
            color: #fff;
        }

        .btn-primary-red:hover {
            background-color: #A00D25 !important;
            border-color: #A00D25 !important;
        }

        .table-primary-red {
            background-color: #C8102E !important;
            color: #fff;
        }

        #loadingOverlay {
            display: none;
            /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;

            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body class="bg-light">
    <div id="nav-container"></div>
    <div class="container py-4" style="margin-top:140px;">
        <div class="card shadow-lg">
            <div class="card-header bg-primary-red text-white d-flex align-items-center">
                <i class="bi bi-calendar-check me-2"></i>
                <h5 class="mb-0">Available Time Slots</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-primary-red">
                            <tr>
                                <th scope="col">Title</th>
                                <th scope="col">Date</th>
                                <th scope="col">Time</th>
                                <th scope="col">Content</th>
                                <th scope="col">Vacancy</th>
                                <th scope="col">Deadline</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="slotList">
                            <tr>
                                <td colspan="7" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="container py-4">
        <div class="card shadow-lg">
            <div class="card-header text-white d-flex align-items-center" style="background-color: green;">
                <i class="bi bi-calendar-check me-2"></i>
                <h5 class="mb-0">My preference(<span id="selectSum"></span>)</h5>
                <button class="btn btn-primary" id="submitPreference">Submit</button>

            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-primary-red">
                            <tr>
                                <th scope="col">Preference</th>
                                <th scope="col">Title</th>
                                <th scope="col">Date</th>
                                <th scope="col">Time</th>
                                <th scope="col">Content</th>
                                <th scope="col">Vacancy</th>
                                <th scope="col">Deadline</th>
                            </tr>
                        </thead>
                        <tbody id="preferenceList">
                            <tr>
                                <td colspan="7" class="text-center text-muted">Waiting your selections...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status" style="width:3rem; height:3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>





    <!-- jQuery + Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
        let slotCount = 0;
        let currentSelectCount = 0;

        $(function () {
            $("#nav-container").load("StudentMenu.html");

            const gid = sessionStorage.getItem("selected_gid");

            if (!gid) {
                $("#slotList").html(
                    `<tr><td colspan="7" class="text-center text-danger">⚠️ No group selected.</td></tr>`
                );
                return;
            }

            // 🔹 載入時間槽
            $.ajax({
                url: "/api/getTimeSlot",
                type: "GET",
                data: { group_id: gid },
                dataType: "json",
                success: function (data) {
                    if (!data || data.length === 0) {
                        $("#slotList").html(
                            `<tr><td colspan="7" class="text-center text-muted">No time slots available.</td></tr>`
                        );
                        return;
                    }

                    $("#slotList").empty();

                    slotCount = data.length;
                    $("#selectSum").text("0/" + slotCount);


                    $.each(data, function (i, item) {
                        const start = new Date(item.start);
                        const end = new Date(item.end);

                        const dateStr = start.toLocaleDateString();
                        const timeStr =
                            start.getHours().toString().padStart(2, "0") + ":" +
                            start.getMinutes().toString().padStart(2, "0") +
                            " – " +
                            end.getHours().toString().padStart(2, "0") + ":" +
                            end.getMinutes().toString().padStart(2, "0");

                        const deadlineStr = new Date(item.deadline).toLocaleString();


                        const isFull = item.vacancy <= 0;

                        let row = `
                                <tr>
                                    <td><span class="fw-bold text-primary-red">${item.title}</span></td>
                                    <td><i class="bi bi-calendar-event text-primary-red"></i> ${dateStr}</td>
                                    <td><i class="bi bi-clock text-primary-red"></i> ${timeStr}</td>
                                    <td>${item.content || ""}</td>
                                    <td id="vacancy-${item.id}">${item.vacancy}</td>
                                    <td>${deadlineStr}</td>
                                    <td>
                                    <button id="selectBtn-${item.id}" 
                                            class="btn btn-outline-secondary selectBtn"
                                            value="${item.id}">
                                            Select
                                    </button>
                                    </td>
                                </tr>
                                `;


                        $("#slotList").append(row);
                    });
                },
                error: function () {
                    $("#slotList").html(
                        `<tr><td colspan="7" class="text-center text-danger">Failed to load slots.</td></tr>`
                    );
                }
            });

            // 🔹 Book 按鈕 POST API
            $(document).on("click", ".selectBtn", function () {
                const row = $(this).closest("tr"); // 取得這一行
                const clone = row.clone();         // 複製這一行

                const slotId = $(this).val(); // 這裡來自上方 Select 按鈕的 value

                // 🔹 改：同時設置 data-slotid 和 value
                clone.find("td:last").html(`
                    <button class="btn btn-sm btn-danger removeBtn"
                    
                                value="${slotId}">
                            Remove
                        </button>
                    `);
                // 清掉下方提示文字
                $("#preferenceList .text-muted").closest("tr").remove();

                // 加進下方表格
                const order = $("#preferenceList tr").length + 1;

                // 在最前面加一個新欄位顯示序號
                clone.prepend(`<td class="fw-bold text-danger">${order}</td>`);

                // 加進下方表格
                $("#preferenceList").append(clone);
                // 改變按鈕狀態
                $(this).prop("disabled", true).text("Added");

                currentSelectCount = currentSelectCount + 1;
                $("#selectSum").text(currentSelectCount + "/" + slotCount);
            });

            $(document).on("click", ".removeBtn", function () {
                const row = $(this).closest("tr");
                const slotId = $(this).val(); // 從 value 取出 id
                row.remove();
                

                // 用 slotId 找回上方的按鈕
                const selectBtn = $(`#selectBtn-${slotId}`);
                selectBtn.prop("disabled", false).text("Select");

                $("#preferenceList tr").each(function (index) {
                    $(this).find("td:first").text(index + 1);
                });

                // 如果刪光了，加回提示文字
                if ($("#preferenceList tr").length === 0) {
                    $("#preferenceList").html(`
                <tr>
                    <td colspan="7" class="text-center text-muted">Waiting your selections...</td>
                </tr>
            `);
                }

                currentSelectCount = currentSelectCount - 1;
                $("#selectSum").text(currentSelectCount + "/" + slotCount);
            });

            $(document).on("click", "#submitPreference", function () {
                // 收集所有偏好選項
                let preferenceArray = [];

                $("#preferenceList .removeBtn").each(function () {
                    const val = $(this).val();
                    preferenceArray.push(val);
                });

                if (currentSelectCount < slotCount) {
                    alert("You need to assign an order number to every slot.");
                    return;
                }

                // 顯示遮罩
                $("#loadingOverlay").css("display", "flex");

                const gid = sessionStorage.getItem("selected_gid");

                // 🔹 發送 POST 請求
                $.ajax({
                    url: "/api/reserveTimeSlot",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        group_id: gid,
                        slot_id: preferenceArray
                    }),
                    success: function (res) {
                        console.log("✅ response:", res);
                        setTimeout(() => {
                            $("#loadingOverlay").fadeOut(200, () => {
                                if (res.success) {
                                    alert("預約成功！");
                                    sessionStorage.removeItem("selected_gid");
                                    window.location.href = "MyCommingBooking.html";
                                } else {
                                    alert("❌ " + res.error);
                                }
                            });
                        }, 800); // 至少顯示0.8秒遮罩
                    },
                    error: function (xhr) {
                        console.error("❌ ajax error", xhr);
                        setTimeout(() => {
                            $("#loadingOverlay").fadeOut(200, () => {
                                alert("伺服器錯誤，請稍後再試");
                            });
                        }, 800);
                    }
                });
            });


        });



    </script>
</body>

</html>