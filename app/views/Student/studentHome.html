<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Student Reservation Calendar (Bootstrap Minimal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    /* å°½é‡å°‘ç”¨CSSï¼Œä»…åšå¿…è¦å¾®è°ƒ */
    .fc .fc-timegrid-slot {
      height: 28px;
    }

    /* è¡Œé«˜æ›´ç´§å‡‘ */
    .fc {
      --fc-border-color: rgba(0, 0, 0, .06);
    }

    .fc .fc-day-today {
      background: rgba(13, 110, 253, .06);
    }

    /* ä»Šæ—¥æ·¡è“åº• */
  </style>
</head>

<body class="bg-light">
  <div id="nav-container"></div>

  <div class="container py-4" " style="margin-top:140px;">
    <div class="d-flex align-items-end justify-content-between mb-3">
      <div>
        <h3 class="mb-1">ğŸ“… 2025 Semester 1</h3>
        <div class="text-muted small">Use the controls to navigate and switch views</div>
      </div>

      <!-- è§†å›¾åˆ‡æ¢ï¼ˆBootstrap segmented controlï¼‰ -->
      <div class="btn-group" role="group" aria-label="View switch">
        <input type="radio" class="btn-check" name="view" id="view-week" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="view-week">Week</label>

        <input type="radio" class="btn-check" name="view" id="view-month" autocomplete="off">
        <label class="btn btn-outline-primary" for="view-month">Month</label>
      </div>
    </div>

    <!-- å¯¼èˆªæ ï¼ˆä¸Šä¸€æœˆ/å‘¨ã€ä»Šå¤©ã€ä¸‹ä¸€æœˆ/å‘¨ï¼‰ -->
    <div class="d-flex gap-2 align-items-center mb-3">
      <div class="btn-group" role="group" aria-label="Navigation">
        <button id="btn-prev" type="button" class="btn btn-outline-secondary">
          â€¹ Prev
        </button>
        <button id="btn-today" type="button" class="btn btn-outline-secondary">
          Today
        </button>
        <button id="btn-next" type="button" class="btn btn-outline-secondary">
          Next â€º
        </button>
      </div>
      <div class="ms-auto text-secondary" id="current-range"></div>
    </div>

    <!-- æ—¥å†å¡ç‰‡ -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div>

          <input list="teacherList" id="teacherInput" class="form-control"
            placeholder="Input professor name eg. HONG Xincong..." style="width: 350px;">
          <datalist id="teacherList">
            <option value="Mr. Smith">
            <option value="Ms. Johnson">
            <option value="Dr. Brown">
            <option value="Prof. Davis">
          </datalist>
        </div>
        <br>
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- äº‹ä»¶è¯¦æƒ… Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventTitle">Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <span class="badge text-bg-primary" id="eventCourse"></span>
          </div>
          <div class="mb-1"><strong>Time:</strong> <span id="eventTime"></span></div>
          <div class="mb-1"><strong>ID:</strong> <span id="eventId"></span></div>
          <div class="mb-1"><strong>Status:</strong> <span id="eventStatus"></span></div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button id="reserveBtn" class="btn btn-primary reserveBtn">Reserve this slot</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
  <script>
    $(function () {
      $("#nav-container").load("StudentMenu.html", function (response, status, xhr) {
        if (status == "error") {
          console.error("è¼‰å…¥ StudentMenu.html å¤±æ•—:", xhr.status, xhr.statusText);
        }
      });
      let calendar = null;

      // å°è£…æ¸²æŸ“æ—¥å†çš„å‡½æ•°
      function renderCalendar(teacherId) {
        if (calendar) {
          calendar.destroy(); // å…ˆé”€æ¯æ—§çš„
        }

        calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
          locale: 'en',
          initialView: 'timeGridWeek',
          headerToolbar: false,
          firstDay: 1,
          height: 'auto',
          slotMinTime: '08:30:00',
          slotMaxTime: '22:30:00',
          nowIndicator: true,
          navLinks: true,
          selectable: true,
          selectMirror: true,

          events: {
            url: '/api/getTimeSlot',
            method: 'GET',
            extraParams: { teacher_id: teacherId },
            failure: function () {
              alert('Failed to load time slots.');
            }
          },

          // âœ… ç‚¹å‡»äº‹ä»¶ â†’ æ‰“å¼€ Modal
          eventClick: function (info) {
            const ev = info.event;
            if (ev.extendedProps?.canBook === false) {
              console.log("âŒ Slot not bookable:", ev.id);
              return; // ä¸è§¦å‘ Modal
            }

            $("#eventTitle").text(ev.title);
            $("#eventCourse").text(ev.title.split(" - ")[0] || "Course");
            $("#eventId").text(ev.id);
            $("#eventStatus").text(ev.extendedProps?.status ?? "");
            $("#reserveBtn").val(ev.id);

            const fmt = (d) => d.toLocaleString('en-US', {
              dateStyle: 'medium',
              timeStyle: 'short',
              hour12: true
            });
            $("#eventTime").text(`${fmt(ev.start)} â€“ ${fmt(ev.end)}`);

            // âœ… æ‰“å¼€ Modal
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));
            modal.show();
          }
        });

        calendar.render();
      }


      // 1. åŠ è½½è€å¸ˆåˆ—è¡¨
      $.getJSON("/api/getTeachersNameList", function (data) {
        let options = "";
        data.forEach(t => {
          options += `<option value="${t.name}" data-teacher_id="${t.id}"></option>`;
        });
        $("#teacherList").html(options);
      });

      // 2. ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
      $("#teacherInput").on("change", function () {
        const inputVal = $(this).val().trim();
        const selectedOption = $("#teacherList option").filter(function () {
          return this.value === inputVal;
        });

        const teacherId = selectedOption.data("teacher_id");

        if (!teacherId) {
          if (calendar) {
            calendar.destroy();
            calendar = null;
          }
          $("#calendar").html("<div class='text-muted'>Please choose a teacher to see the calendar.</div>");
          return;
        }

        // âœ… è°ƒç”¨æ¸²æŸ“å‡½æ•°
        renderCalendar(teacherId);
      });

      // æ›´æ–°æ—¥å†èŒƒå›´æ–‡å­—
      function updateRangeText() {
        if (!calendar) return;
        const view = calendar.view;
        const fmt = new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' });
        $("#current-range").text(
          view.type === 'dayGridMonth'
            ? fmt.format(view.currentStart)
            : `${fmt.format(view.currentStart)} â€“ ${fmt.format(view.currentEnd)}`
        );
      }

      // ç»‘å®šå¯¼èˆªæŒ‰é’®
      $("#btn-prev").on("click", function () {
        if (calendar) {
          calendar.prev();
          updateRangeText();
        }
      });

      $("#btn-next").on("click", function () {
        if (calendar) {
          calendar.next();
          updateRangeText();
        }
      });

      $("#btn-today").on("click", function () {
        if (calendar) {
          calendar.today();
          updateRangeText();
        }
      });

      // ç‚¹å‡» Reserve æŒ‰é’®
      $(".reserveBtn").on("click", function () {
        const timeSlotId = $(this).val(); // ä»æŒ‰é’®å– id

        $.ajax({
          url: "/api/reserveTimeSlot",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ time_slot_id: timeSlotId }), // âœ… ç›´æ¥å¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„
          success: function (resp) {
            console.log("âœ… Reservation success:", resp);
            alert("Reservation success!\n" + JSON.stringify(resp, null, 2));
          },
          error: function (xhr) {
            console.error("âŒ Reservation failed:", xhr.responseText);
            alert("Reservation failed!");
          }
        });
      });





      // æ‰“å°å‡ºæ¥è°ƒè¯•



    });


  </script>



</body>

</html>