<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Booking List</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    th {
      cursor: pointer;
    }
  </style>
</head>

<body class="bg-light">

  <!-- Header iframe -->
  <div id="nav-container" style="margin-top:120px;"></div>

  <!-- Booking 列表 -->
  <div class="container py-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <!-- Slot 信息 -->
        <div id="slotInfo" class="mb-3"></div>

        <!-- 搜索框 -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
          <h4 class="mb-0">
            <i class="fa-solid fa-clock text-danger me-1"></i> Booking List
          </h4>
          <input type="text" id="searchInput" class="form-control w-auto" placeholder="Search student...">
        </div>

        <!-- 表格 -->
        <table class="table table-hover align-middle" id="bookingTable">
          <thead>
            <tr>
              <th scope="col">Student ID</th>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col" class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- jQuery 動態渲染 -->
          </tbody>
        </table>

      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    $(document).ready(function () {
      $("#nav-container").load("TeacherMenu.html");

      // 從 URL 拿 time_slot_id
      const params = new URLSearchParams(window.location.search);
      const timeSlotId = params.get("id");

      if (!timeSlotId) {
        alert("❌ 缺少 time_slot_id");
        return;
      }

      // AJAX 拿數據
      $.ajax({
        url: `/api/getStudentListByTimeSlotID?time_slot_id=${timeSlotId}`,
        method: "GET",
        dataType: "json",
        success: function (data) {
          if (!data?.length) return;
          const slot = data[0].slot;
          if (!slot) return;

          // 顯示 slot 信息
          $("#slotInfo").html(`
            <h5>
              <i class="fa-solid fa-calendar text-danger me-2"></i>
              ${slot.title} (${slot.start} - ${slot.end})
              <br>
              <small class="text-muted">Content: ${slot.content || "N/A"} | Capacity: ${slot.capacity}</small>
            </h5>
          `);

          const tbody = $("#bookingTable tbody");
          tbody.empty();

          if (slot.status === "Reserved") {
            // 遍歷學生
            const students = data[1]?.students || [];
            if (students.length === 0) {
              tbody.append(`<tr><td colspan="4" class="text-center">No matched students</td></tr>`);
            } else {
              students.forEach(s => {
                tbody.append(`
                  <tr>
                    <td>${s.student_id}</td>
                    <td>${s.student_name}</td>
                    <td>${s.email}</td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-success checkin-btn">
                        <i class="fa-solid fa-check"></i> Check-in
                      </button>
                    </td>
                  </tr>
                `);
              });
            }
          } else {
            // 顯示 Match 按鈕
            tbody.append(`
              <tr>
                <td colspan="4" class="text-center">
                  <button class="btn btn-warning match-btn" value="${timeSlotId}">Match</button>
                </td>
              </tr>
            `);
          }
        },
        error: function (xhr) {
          console.error("❌ Failed:", xhr.responseText);
        }
      });

      // 搜索功能
      document.getElementById("searchInput").addEventListener("keyup", function () {
        let filter = this.value.toLowerCase().trim();
        let rows = document.querySelectorAll("#bookingTable tbody tr");
        rows.forEach(row => {
          let text = row.innerText.toLowerCase();
          row.style.display = text.includes(filter) ? "" : "none";
        });
      });

      // 排序功能
      document.querySelectorAll("#bookingTable thead th").forEach((th, colIndex) => {
        th.addEventListener("click", function () {
          const table = document.getElementById("bookingTable");
          const tbody = table.tBodies[0];
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const ascending = th.classList.toggle("asc");

          rows.sort((a, b) => {
            let A = a.cells[colIndex].innerText.trim().toLowerCase();
            let B = b.cells[colIndex].innerText.trim().toLowerCase();
            if (!isNaN(A) && !isNaN(B)) { A = Number(A); B = Number(B); }
            if (A < B) return ascending ? -1 : 1;
            if (A > B) return ascending ? 1 : -1;
            return 0;
          });

          rows.forEach(row => tbody.appendChild(row));
        });
      });


      $(document).on("click", ".match-btn", function () {
        const timeSlotId = $(this).val();

        $.ajax({
          url: "/api/mactchAlgorithm",
          method: "POST",
          data: { time_slot_id: timeSlotId },  // ✅ 用 form-data 傳遞參數
          success: function (resp) {
            console.log("✅ Match API response:", resp);
            alert("Match 成功！ 已處理 " + resp.number_matched + " 位學生");
            location.reload();
          },
          error: function (xhr) {
            console.error("❌ Match API failed:", xhr.responseText);
            alert("Match 失敗！");
          }
        });

      });

    });
  </script>

</body>

</html>